<%= form_for @client, :html => { class: 'form-horizontal' } do |f| %>
  <% unless @client.new_record? %> 
    <% if @client.user %>
      <%= gravatar_for @client.user.email, size: 48, style: 'position:absolute;' %>
    <% end %>
    <%=link_to(client_path(@client), method: :delete, confirm: I18n.t(:confirm_delete_client), class: 'btn btn-danger pull-right') do%> 
      <i class="icon-trash icon-white"></i>
    <% end %>
  <% end %>

  <div class="control-group extended-edit">
    <label class="control-label" for="name">
      <%=t :user, scope: [:activerecord, :models, :client]%>
    </label>
    <div class="controls">
      <%= collection_select(:client, :user_id, User.all, :id, :name) %>
    </div>
  </div>

  <div class="control-group ">
    <label class="control-label" for="client_name">
      <%=t :name, scope: [:activerecord, :models, :client]%>
    </label>
    <div class="controls">
      <%= f.text_field(:name, class: "input-xxlarge disabled", disabled: :disabled) %>
      <div style="display: inline-block">
        <a href="#" class="btn form-edit-link"><i class="icon-edit"></i></a>
      </div>
    </div>
  </div>

  <div class="control-group extended-edit">
    <label class="control-label" for="client_local_name">
      <%=t :local_name, scope: [:activerecord, :models, :client]%>
    </label>
    <div class="controls">
      <%= f.text_field(:local_name, class: "input-xxlarge") %>
    </div>
  </div>

  <div class="control-group extended-edit">
    <label class="control-label" for="contacts">
      <%=t :contacts, scope: [:activerecord, :models, :client]%>
      <span class="btn" id="add_contact"><i class="icon-plus"></i></span>
    </label>
    <div class="controls">
      <div id="contacts">
        <%= render @client.contacts %>
      </div>
    </div>
  </div>
  <div class="control-group extended-edit">
    <label class="control-label" for="billing_addresses">
      <%=t :billing_addresses, scope: [:activerecord, :models, :client]%>
      <span class="btn" id="add_billing_address"><i class="icon-plus"></i></span>
    </label>
    <div class="controls">
      <div id="billing_addresses">
        <%= render @client.billing_addresses %>
      </div>
    </div>
  </div>

  <div class="control-group extended-edit">
    <label class="control-label" for="accounting_code">
      <%=t :accounting_code, scope: [:activerecord, :models, :client]%>
    </label>
    <div class="controls">
      <%= f.text_field(:accounting_code, class: 'input-small')%>
    </div>
  </div>

  <div class="control-group">
    <label class="control-label" for="memo">
      <%=t :memo, scope: [:activerecord, :models, :memo]%>
    </label>
    <div class="controls">
      <%= f.text_area(:memo, :rows => 10, class: "input-xxlarge disabled", disabled: :disabled) %>
    </div>
  </div>

  <div class="form-actions extended-edit">
    <button type="submit" id="save_client" class="btn"><%=t :save%></button>
  </div>

<% end %>
  <%= render 'add_contact' %>
  <%= render 'contacts/contact', contact: Contact.new, hidden: true %>
  <%= render 'add_billing_address' %>
  <%= render 'billing_addresses/billing_address', billing_address: BillingAddress.new, hidden: true %>
  <script type="text/javascript">
    $(document).ready(function() {
        $('.btn.edit-contact').live('click', function() { client.edit_contact(this) }) 
        $('.btn.remove-contact').live('click', function() {client.remove_contact(this) })
        $('.btn.edit-billing-address').live('click', function() { client.edit_billing_address(this) }) 
        $('.btn.remove-billing-address').live('click', function() {client.remove_billing_address(this) })


        $('.form-edit-link').live('click', function() { client.edit(this) })
        $('#add_contact').click(function() {
          $('#add_contact_form').removeData('contact')
          $('#add_contact_form').modal()
          });
        $('#add_billing_address').click(function() {
          $('#add_billing_address_form').removeData('billing_address');
          $('#add_billing_address_form').modal();
          });
        });

var client = {
edit: function(link) {
        var form = $(link).closest('form');
        form.find(':disabled').removeAttr('disabled');
        form.find('.extended-edit').show();
        $(link).hide();
      },
add_contact : function(contact_info) {
                contact = this._add_association('contact', 'contacts', contact_info);
                contact.find('[name="client-name"]').text($('#client_name').val());
                contact.find('[name="client-local_name"]').text($('#client_local_name').val());
              },


add_billing_address : function(billing_address_info) {
                        billing_address = this._add_association('billing_address', 'billing_addresses', billing_address_info);
                      },

edit_contact : function(edit_el) {
                 this._edit_association($(edit_el), 'contact');
               },
edit_billing_address : function(edit_el) {
                         this._edit_association($(edit_el), 'billing_address');
                       },

remove_contact: function(trash_el) {
                  this._remove_association($(trash_el), 'contact', 'contacts');
                },
remove_billing_address: function(trash_el) {
                          this._remove_association($(trash_el), 'billing_address', 'billing_addresses');
                        },
_update_association: function(object, data, association, attributes_name) {
                       var prefix = ['client[',attributes_name,'_attributes][]['].join('');
                       for(var x in data) {
                         var input_el = ["[name='",prefix,x,"]']"].join('');
                         var label_el = ["[name='",x,"']"].join('');
                         object.find(input_el).val(data[x]);
                         object.find(label_el).text(data[x]);
                       }
                     },

_add_association: function(association, target, association_info) {
                    var form_selector = ['#add_',association,'_form'].join('');
                    var card_style = [association, '-card'].join('');
                    var target_selector = ['#',target].join('');
                    var template_selector = ['.',association, '-card-template'].join('');
                    var data = $(form_selector).data(association);

                    if(typeof data == 'undefined') {
                      data = $(template_selector).clone();
                      data.removeClass(template_selector);
                      data.addClass(card_style);
                      data.appendTo($(target_selector));
                    }
                    this._update_association(data, association_info, association, target);
                    return data;
                  },

_edit_association: function(source, association) {
                     var card_selector = ['.',association,'-card'].join('');
                     var form_selector = ['#add_',association,'_form'].join('');
                     var card = source.closest(card_selector);
                     var inputs = $(form_selector + ' index');
                     $.map(inputs, function(input, index) {
                         input.value = card.find("[name='" + input.id + '"]').text();
                         });
                     $(form_selector).data(association, card);
                     $(form_selector).modal();
                   },
_remove_association: function(source, association, attributes_name) {
                       var card_selector = ['.',association,'-card'].join('');
                       var association_id_selector = ['[name="',attributes_name,'_attributes[][id]"]'].join('');
                       var destroy_input = ['<input type="hidden" name="',attributes_name,'_attributes][][_destroy]" value="1">'].join('');
                       var destroy_style = [association,'-card-destroy'].join('');

                       card = $(source).closest(card_selector);
                       if(card.find(association_id_selector).length) {
                         card.append(destroy_input);
                         card.find('icon-edit').parent().hide();
                         card.find('icon-trash').parent().hide();
                       } else {
                         card.remove();
                       }
                     }
}

</script>
